# Analysing the Fairness of Stable Diffusion with instructions from ChatGPT-4

Chuong Huynh - Quynh Phung

Project of CMSC742 - Spring 2023 - Professor Furong Huang

## Requirements
Create the environment by running thise line:
```
conda create --name fairness --file requirements.txt
```
Activate the environment by `conda activate fairness`
## Preparing dataset
### FairFace dataset

You need to download the FairFace dataset [here](https://drive.google.com/file/d/1Z1RqRo0_JiavaZw2yzZG6WETdZQ8qX86/view) and [train](https://drive.google.com/file/d/1i1L3Yqwaio7YSOCj7ftgk8ZZchPG7dmH/view), [val](https://drive.google.com/file/d/1wOdja-ezstMEp81tX1a-EYkFebev4h7D/view) labels and put to the directory `./data` 

### Non-binary gender

Download the images here and save to the folder `./data/nonbin_gender`

## Finetune FaRL on FairFace dataset

Download the [pretrained weights](https://1drv.ms/u/s!AperexS2nqQom0Zu3lsuM28UbEgP) of LAION-Face to `.weights`

Finetune the model with the following command:
```
python train_FaRL.py
```

You can check the training log [here](weights/train_farl_fairface.log) and download the trained weights [here]()

## Generate the images
### Normal images from Stable Diffusion Models:
```
python generate_images.py --mode generate --sd-version 1.5 --split 0
```
where ` --sd-version` can be 1.1 or 2.1 and `--split` can be 0-7 to run on multiple processes.

### Images with bias-free prompt:
Plese use the flag `--use-bias-free-prompt`. For example:
```
python generate_images.py --mode generate --sd-version 1.5 --split 0 --use-bias-free-prompt
```

## Evaluate the generated images

### Predict attributes of generated images

We need to predict all attributes of generated images. After finishing the image generation for one model, please run:
```
python predict_facial_attr.py --dir generated_images/sd_1-5 --gpu 0
```
with `--dir` is the folder containing images generated by a model and we want to run on GPU 0.

You can download all attributes predicted [here](https://drive.google.com/drive/folders/1FErYZs9HZbgnHgjOTn6s8DYt2fIxdGW9?usp=share_link)

### Analyze results

Please refer to [analyze.ipynb](analyze.ipynb)
